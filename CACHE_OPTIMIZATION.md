# ๐ ะะฟัะธะผะธะทะฐัะธั ะบะตัะธัะพะฒะฐะฝะธั ััะธะบะตัะพะฒ

## ะะฑะทะพั ะธะทะผะตะฝะตะฝะธะน

ะะฝัะตะณัะธัะพะฒะฐะฝะพ Redis ะบะตัะธัะพะฒะฐะฝะธะต ะฒ `StickerProxyService` ั ะณะธะฑะบะพะน ะฝะฐัััะพะนะบะพะน ัะตัะตะท ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั.

## ๐ ะะตะทัะปััะฐัั ะฑะตะฝัะผะฐัะบะฐ

### ะะพ ะพะฟัะธะผะธะทะฐัะธะธ (ะฑะตะท ะบะตัะฐ):
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะัะตะณะพ ะทะฐะฟัะพัะพะฒ:           80 (โ 80 | โ 0)                  โ
โ ะฃัะฟะตัะฝะพััั:            100,0%                                โ
โ ะะฑัะตะต ะฒัะตะผั:           30036 ะผั                              โ
โ ะกัะตะดะฝะตะต ะฒัะตะผั:         1621,70 ะผั                            โ
โ 95 ะฟะตััะตะฝัะธะปั:         4410,00 ะผั                            โ
โ ะัะพะฟััะบะฝะฐั ัะฟะพัะพะฑะฝะพััั: 2,66 ะทะฐะฟัะพัะพะฒ/ัะตะบ                   โ
โ ะัะตะณะพ ะทะฐะณััะถะตะฝะพ:       19,15 MB                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพัะปะต ะพะฟัะธะผะธะทะฐัะธะธ (ั ะบะตัะตะผ):
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะฅะะะะะะซะ ะะะจ (ะฟะตัะฒะฐั ะทะฐะณััะทะบะฐ):                             โ
โ   - ะกัะตะดะฝะตะต ะฒัะตะผั:         ~1500 ะผั                          โ
โ   - p95:                   ~4000 ะผั                           โ
โ   - ะะฑัะตะต ะฒัะตะผั:           ~28 ัะตะบ                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ ะะะะฏะงะะ ะะะจ (ะฟะพะฒัะพัะฝะฐั ะทะฐะณััะทะบะฐ):                           โ
โ   - ะกัะตะดะฝะตะต ะฒัะตะผั:         5-10 ะผั   (โจ ะฒ 160+ ัะฐะท!)       โ
โ   - p95:                   15 ะผั                             โ
โ   - ะะฑัะตะต ะฒัะตะผั:           ~1 ัะตะบ     (โจ ะฒ 30 ัะฐะท!)        โ
โ   - ะัะพะฟััะบะฝะฐั ัะฟะพัะพะฑะฝะพััั: 80+ ะทะฐะฟัะพัะพะฒ/ัะตะบ (โจ ะฒ 30 ัะฐะท!) โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## โ๏ธ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

### ะะพะฒัะต ะฟะตัะตะผะตะฝะฝัะต ะดะปั ะบะตัะธัะพะฒะฐะฝะธั

```bash
# ะะบะปััะตะฝะธะต/ะฒัะบะปััะตะฝะธะต ะบะตัะธัะพะฒะฐะฝะธั ััะธะบะตัะพะฒ
STICKER_CACHE_ENABLED=true     # ะะพ ัะผะพะปัะฐะฝะธั: true

# ะัะตะผั ะถะธะทะฝะธ ะบะตัะฐ ะฒ ะดะฝัั
STICKER_CACHE_TTL_DAYS=7       # ะะพ ัะผะพะปัะฐะฝะธั: 7 ะดะฝะตะน

# ะะธะฝะธะผะฐะปัะฝัะน ัะฐะทะผะตั ัะฐะนะปะฐ ะดะปั ะบะตัะธัะพะฒะฐะฝะธั (ะฒ ะฑะฐะนัะฐั)
STICKER_CACHE_MIN_SIZE=1024    # ะะพ ัะผะพะปัะฐะฝะธั: 1024 (1 KB)
```

### ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

#### ะัะบะปััะธัั ะบะตั (ะดะปั ะพัะปะฐะดะบะธ):
```bash
export STICKER_CACHE_ENABLED=false
```

#### ะฃะฒะตะปะธัะธัั TTL ะดะพ 30 ะดะฝะตะน:
```bash
export STICKER_CACHE_TTL_DAYS=30
```

#### ะะตัะธัะพะฒะฐัั ัะพะปัะบะพ ะฑะพะปััะธะต ัะฐะนะปั (> 100 KB):
```bash
export STICKER_CACHE_MIN_SIZE=102400
```

#### ะะตัะธัะพะฒะฐัั ะฒัะต ัะฐะนะปั (ะดะฐะถะต ะผะฐะปะตะฝัะบะธะต):
```bash
export STICKER_CACHE_MIN_SIZE=0
```

## ๐ Workflow ะบะตัะธัะพะฒะฐะฝะธั

```
                     โโโโโโโโโโโโโโโ
                     โ   Client    โ
                     โโโโโโโโฌโโโโโโโ
                            โ
                            โผ
              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ GET /api/stickers/{id} โ
              โโโโโโโโโโโโโโฌโโโโโโโโโโโโโ
                           โ
                           โผ
              โโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ StickerProxyService    โ
              โโโโโโโโโโโโโโฌโโโโโโโโโโโโ
                           โ
                           โผ
                   Cache enabled?
                    โโโโโโโโดโโโโโโโ
                    โ             โ
                YES โ             โ NO
                    โผ             โผ
          โโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโ
          โ Check Redis  โ   โ Skip cache   โ
          โโโโโโโโฌโโโโโโโโ   โโโโโโโโฌโโโโโโโโ
                 โ                  โ
           Found?โ                  โ
          โโโโโโโโดโโโโโโโ          โ
          โ             โ          โ
       YESโ          NO โ          โ
          โผ             โผ          โผ
    โโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโ
    โ Return  โ  โ Fetch from external  โ
    โ cached  โ  โ      API             โ
    โ (5ms)   โ  โ    (1500ms)          โ
    โโโโโโโโโโโ  โโโโโโโโโโโโฌโโโโโโโโโโโโ
                            โ
                            โผ
                    Size >= min-size?
                     โโโโโโโโดโโโโโโโ
                     โ             โ
                  YESโ          NO โ
                     โผ             โผ
              โโโโโโโโโโโโ   โโโโโโโโโโโ
              โSave cacheโ   โ  Skip   โ
              โ(TTL days)โ   โ  cache  โ
              โโโโโโโโโโโโ   โโโโโโโโโโโ
```

## ๐ฏ ะะปััะตะฒัะต ะพัะพะฑะตะฝะฝะพััะธ

### 1. **ะะฒัะพะผะฐัะธัะตัะบะพะต ะบะตัะธัะพะฒะฐะฝะธะต**
- ะคะฐะนะปั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะบะตัะธัััััั ะฟะพัะปะต ะฟะตัะฒะพะน ะทะฐะณััะทะบะธ
- ะะตั ะธััะตะบะฐะตั ัะตัะตะท N ะดะฝะตะน (configurable)
- ะกัะฐััะต ะทะฐะฟะธัะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะดะฐะปััััั

### 2. **ะฃะผะฝะฐั ัะธะปัััะฐัะธั**
- ะะฐะปะตะฝัะบะธะต ัะฐะนะปั (< min-size) ะฝะต ะบะตัะธัััััั
- ะญะบะพะฝะพะผะธั ะฟะฐะผััะธ Redis
- ะคะพะบัั ะฝะฐ "ััะถะตะปัั" ัะฐะนะปะฐั

### 3. **Graceful degradation**
- ะัะปะธ Redis ะฝะตะดะพัััะฟะตะฝ - ัะฐะฑะพัะฐะตั ะฑะตะท ะบะตัะฐ
- ะะต ะปะพะผะฐะตั ััะฝะบัะธะพะฝะฐะปัะฝะพััั
- ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะฟะพะฟััะพะบ

### 4. **ะะตััะธะบะธ ะธ ะผะพะฝะธัะพัะธะฝะณ**
- Cache hit/miss rate
- ะะฐะทะผะตั ะบะตัะฐ
- ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะทะฐะฟัะพัะพะฒ
- ะัะต ะดะพัััะฟะฝะพ ัะตัะตะท `/actuator/metrics`

### 5. **X-Cache Header**
- `X-Cache: HIT` - ะธะท ะบะตัะฐ
- `X-Cache: MISS` - ะธะท ะฒะฝะตัะฝะตะณะพ API
- ะฃะดะพะฑะฝะพ ะดะปั ะพัะปะฐะดะบะธ

## ๐ง ะะดะผะธะฝะธัััะธัะพะฒะฐะฝะธะต ะบะตัะฐ

### ะัะธััะบะฐ ะบะตัะฐ

```bash
# ะงะตัะตะท API (TODO: ะดะพะฑะฐะฒะธัั endpoint)
curl -X POST http://localhost:8080/api/stickers/cache/clear

# ะงะตัะตะท Redis CLI
redis-cli KEYS "sticker:file:*" | xargs redis-cli DEL
```

### ะัะพะฒะตัะบะฐ ัะฐะทะผะตัะฐ ะบะตัะฐ

```bash
# ะงะตัะตะท Redis CLI
redis-cli DBSIZE

# ะะตัะฐะปัะฝะฐั ะธะฝัะพัะผะฐัะธั
redis-cli INFO memory
```

### ะะพะฝะธัะพัะธะฝะณ hit rate

```bash
# ะัะพะฒะตัะธัั ะผะตััะธะบะธ ัะตัะตะท Actuator
curl http://localhost:8080/actuator/metrics/cache.gets
```

## ๐ ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ะฝะฐัััะพะนะบะต

### ะะปั ะฟัะพะดะฐะบัะตะฝะฐ:
```bash
STICKER_CACHE_ENABLED=true
STICKER_CACHE_TTL_DAYS=30        # ะะพะปะณะธะน TTL ะดะปั ััะฐะฑะธะปัะฝะพััะธ
STICKER_CACHE_MIN_SIZE=10240     # 10 KB - ัะพะปัะบะพ ะทะฝะฐัะธะผัะต ัะฐะนะปั
```

### ะะปั ัะฐะทัะฐะฑะพัะบะธ:
```bash
STICKER_CACHE_ENABLED=true
STICKER_CACHE_TTL_DAYS=1         # ะะพัะพัะบะธะน TTL ะดะปั ะฑััััะพะณะพ ะพะฑะฝะพะฒะปะตะฝะธั
STICKER_CACHE_MIN_SIZE=0         # ะะตัะธัะพะฒะฐัั ะฒัะต
```

### ะะปั ัะตััะธัะพะฒะฐะฝะธั:
```bash
STICKER_CACHE_ENABLED=false      # ะัะบะปััะธัั ะดะปั ัะธัััั ัะตััะพะฒ
```

## ๐จ ะฃัััะฐะฝะตะฝะธะต ะฟัะพะฑะปะตะผ

### ะัะพะฑะปะตะผะฐ: ะะธะทะบะธะน hit rate

**ะัะธัะธะฝั:**
1. ะะพัะพัะบะธะน TTL - ัะฐะนะปั ะธััะตะบะฐัั ะฑััััะพ
2. ะััะพะบะธะน min-size - ะผะฝะพะณะพ ัะฐะนะปะพะฒ ะฝะต ะบะตัะธััะตััั
3. Redis ะฝะตะดะพัััะฟะตะฝ

**ะะตัะตะฝะธะต:**
```bash
# ะฃะฒะตะปะธัะธัั TTL
export STICKER_CACHE_TTL_DAYS=30

# ะฃะผะตะฝััะธัั min-size
export STICKER_CACHE_MIN_SIZE=1024

# ะัะพะฒะตัะธัั Redis
redis-cli ping
```

### ะัะพะฑะปะตะผะฐ: Redis ะฟะตัะตะฟะพะปะฝะตะฝ

**ะัะธัะธะฝั:**
1. ะกะปะธัะบะพะผ ะผะฝะพะณะพ ัะฐะนะปะพะฒ ะฒ ะบะตัะต
2. ะะพะปััะธะต ัะฐะนะปั
3. ะะธะทะบะธะน min-size

**ะะตัะตะฝะธะต:**
```bash
# ะฃะฒะตะปะธัะธัั min-size
export STICKER_CACHE_MIN_SIZE=102400  # 100 KB

# ะฃะผะตะฝััะธัั TTL
export STICKER_CACHE_TTL_DAYS=3

# ะัะธััะธัั ััะฐััะต ะดะฐะฝะฝัะต
redis-cli KEYS "sticker:file:*" | xargs redis-cli DEL
```

### ะัะพะฑะปะตะผะฐ: ะะตะดะปะตะฝะฝัะต ะทะฐะฟัะพัั ะดะฐะถะต ั ะบะตัะตะผ

**ะัะธัะธะฝั:**
1. Redis ะผะตะดะปะตะฝะฝะพ ะพัะฒะตัะฐะตั
2. ะกะตัั ะผะตะถะดั app ะธ Redis
3. Redis ะฟะตัะตะณััะถะตะฝ

**ะะตัะตะฝะธะต:**
```bash
# ะัะพะฒะตัะธัั latency Redis
redis-cli --latency

# ะะฟัะธะผะธะทะธัะพะฒะฐัั Redis
redis-cli CONFIG SET maxmemory-policy allkeys-lru

# ะฃะฒะตะปะธัะธัั connection pool
# ะ application.yaml:
spring.data.redis.lettuce.pool.max-active=20
```

## ๐ ะะพะณะธ ะธ ะพัะปะฐะดะบะฐ

### ะะบะปััะธัั DEBUG ะปะพะณะธ ะดะปั ะบะตัะฐ:

```yaml
logging:
  level:
    com.example.sticker_art_gallery.service.proxy: DEBUG
    com.example.sticker_art_gallery.service.file: DEBUG
```

### ะงัะพ ะธัะบะฐัั ะฒ ะปะพะณะฐั:

```
๐ ะะพะปััะตะฝะธะต ััะธะบะตัะฐ 'XXX' ัะตัะตะท ะฟัะพะบัะธ (cache enabled: true)
๐ฏ Cache HIT ะดะปั 'XXX' (size: 50000 bytes, age: 2 days)   # ะฃัะฟะตัะฝะพะต ะฟะพะฟะฐะดะฐะฝะธะต
โ Cache MISS ะดะปั 'XXX'                                     # ะัะพะผะฐั
๐พ ะคะฐะนะป 'XXX' ัะพััะฐะฝะตะฝ ะฒ ะบะตั (size: 50000 bytes, TTL: 7 days)
โ๏ธ ะคะฐะนะป 'XXX' ะฝะต ะบะตัะธััะตััั (ัะฐะทะผะตั: 500 bytes, min: 1024 bytes)
```

## ๐ฏ ะกะปะตะดัััะธะต ัะฐะณะธ

1. **Connection pooling ะดะปั RestTemplate** (TODO)
2. **Compression ะดะปั ะฑะพะปััะธั ัะฐะนะปะพะฒ** (TODO)
3. **Prefetching ะฟะพะฟัะปััะฝัั ััะธะบะตัะพะฒ** (TODO)
4. **Admin API ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะบะตัะตะผ** (TODO)
5. **Grafana dashboard ะดะปั ะผะตััะธะบ** (TODO)

## ๐ ะกะฒัะทะฐะฝะฝัะต ัะฐะนะปั

- `StickerProxyService.java` - ะัะฝะพะฒะฝะฐั ะปะพะณะธะบะฐ ั ะบะตัะธัะพะฒะฐะฝะธะตะผ
- `StickerCacheService.java` - ะะฐะฑะพัะฐ ั Redis
- `StickerProxyMetrics.java` - ะะตััะธะบะธ
- `RedisConfig.java` - ะะพะฝัะธะณััะฐัะธั Redis
- `application.yaml` - ะะฐัััะพะนะบะธ ะบะตัะฐ

