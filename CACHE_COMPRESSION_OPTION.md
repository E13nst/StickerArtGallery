# üóúÔ∏è –û–ø—Ü–∏—è —Å–∂–∞—Ç–∏—è Redis –∫–µ—à–∞

## üìä –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

**–ë–µ–∑ —Å–∂–∞—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)**:
- ‚úÖ –ù–µ—Ç overhead –Ω–∞ CPU (—ç–∫–æ–Ω–æ–º–∏—è 10-15% –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
- ‚ö†Ô∏è –ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞ –≤ Redis (~2-3x —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤)

**–°–æ —Å–∂–∞—Ç–∏–µ–º** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞ –≤ Redis: 30-50%
- ‚ö†Ô∏è Overhead –Ω–∞ CPU: 5-10% –ø—Ä–∏ –∑–∞–ø–∏—Å–∏, 5-8% –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∂–∞—Ç–∏–µ

**–ü—Ä–∏—á–∏–Ω—ã**:
1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –ø–∞–º—è—Ç–∏**: Redis –æ–±—ã—á–Ω–æ –∏–º–µ–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏
2. **CPU overhead**: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∫–µ—à—É
3. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ —Å–∂–∞—Ç–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ (100% hit rate)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∂–∞—Ç–∏–µ**:
- –ï—Å–ª–∏ Redis –ª–∏–º–∏—Ç –ø–æ –ø–∞–º—è—Ç–∏ (< 1GB)
- –ï—Å–ª–∏ —Å—Ç–∏–∫–µ—Ä—ã –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–µ (> 500KB –∫–∞–∂–¥—ã–π)
- –ï—Å–ª–∏ –±—é–¥–∂–µ—Ç –Ω–∞ CPU –ø–æ–∑–≤–æ–ª—è–µ—Ç 5-10% overhead

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ë–ï–ó —Å–∂–∞—Ç–∏—è)

```yaml
app:
  sticker-cache:
    compress:
      enabled: false           # ‚Üê –°–∂–∞—Ç–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
      compress-by-size: 100000 # –°–∂–∏–º–∞—Ç—å —Ñ–∞–π–ª—ã > 100KB
```

### –í–∫–ª—é—á–∏—Ç—å —Å–∂–∞—Ç–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

–í `.env.app`:
```bash
STICKER_CACHE_COMPRESS_ENABLED=true
STICKER_CACHE_COMPRESS_BY_SIZE=100000  # –°–∂–∏–º–∞—Ç—å —Ñ–∞–π–ª—ã –±–æ–ª—å—à–µ 100KB
```

–ò–ª–∏ –≤ `application.yaml`:
```yaml
app:
  sticker-cache:
    compress:
      enabled: true              # ‚Üê –í–∫–ª—é—á–∏—Ç—å —Å–∂–∞—Ç–∏–µ
      compress-by-size: 100000   # –°–∂–∏–º–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã > 100KB
```

### –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–æ—á–Ω–æ–≥–æ —Å–∂–∞—Ç–∏—è

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∂–∞—Ç–∏–µ –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∞–≤–∏–ª–∞–º:

1. ‚úÖ **WebP –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** - –ù–ï —Å–∂–∏–º–∞—é—Ç—Å—è (—É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –º–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä)
2. ‚úÖ **TGS –∞–Ω–∏–º–∞—Ü–∏–∏** - —Å–∂–∏–º–∞—é—Ç—Å—è –µ—Å–ª–∏ > 100KB (–±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã)
3. ‚úÖ **MP4 –≤–∏–¥–µ–æ** - —Å–∂–∏–º–∞—é—Ç—Å—è –µ—Å–ª–∏ > 100KB
4. ‚úÖ **–ú–∞–ª–µ–Ω—å–∫–∏–µ —Ñ–∞–π–ª—ã** - –ù–ï —Å–∂–∏–º–∞—é—Ç—Å—è (—ç–∫–æ–Ω–æ–º–∏—è CPU)

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ **–ß–∏—Ç–∞–µ—Ç** –∏ —Å–∂–∞—Ç—ã–µ, –∏ –Ω–µ—Å–∂–∞—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Redis
- ‚úÖ **–ü–∏—à–µ—Ç** –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –∑–∞–¥–∞–Ω–Ω–æ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π `compress`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –ø–æ —Ñ–ª–∞–≥—É `compressed`

### –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Redis

**–ë–µ–∑ —Å–∂–∞—Ç–∏—è** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):
```json
{
  "fileId": "CAACAgI...",
  "fileData": "base64_data...",
  "compressed": false
}
```

**–°–æ —Å–∂–∞—Ç–∏–µ–º**:
```json
{
  "fileId": "CAACAgI...",
  "fileData": "base64_compressed_data...",
  "compressed": true
}
```

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ë–ï–ó —Å–∂–∞—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ‚úÖ

**–ú–µ—Ç—Ä–∏–∫–∏** (–∏–∑ –±–µ–Ω—á–º–∞—Ä–∫–∞):
- Hit Rate: **100%** ‚úÖ
- Cache HITS: 800
- Errors: 0
- **CPU overhead**: 0%
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è ‚ö°

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–æ —Å–∂–∞—Ç–∏–µ–º

**–ú–µ—Ç—Ä–∏–∫–∏** (—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ):
- Hit Rate: **100%** ‚úÖ
- **CPU overhead**: +5-10% (—Å–∂–∞—Ç–∏–µ/—Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞)
- **–≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏**: 30-50%
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ù–µ–º–Ω–æ–≥–æ –Ω–∏–∂–µ (5-10% –º–µ–¥–ª–µ–Ω–Ω–µ–µ)

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í–∫–ª—é—á–∏—Ç—å —Å–∂–∞—Ç–∏–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫

```bash
# 1. –í–∫–ª—é—á–∏—Ç—å —Å–∂–∞—Ç–∏–µ
export STICKER_CACHE_COMPRESS=true

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
make restart

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫
make test-benchmark-serve

# 4. –°—Ä–∞–≤–Ω–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏:
# - Response time (avg, p95)
# - Throughput (req/s)
# - CPU usage
```

---

## üéõÔ∏è –í—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### –î–ª—è Production (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```yaml
app:
  sticker-cache:
    compress: false  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
```

### –î–ª—è dev/staging —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç—å—é
```yaml
app:
  sticker-cache:
    compress: true   # –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏
```

---

## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. StickerCacheDto
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `compressed` (Boolean)
- `getFileBytes()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏
- `setData()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∂–∏–º–∞–µ—Ç –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ (–µ—Å–ª–∏ —Ñ–ª–∞–≥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)

### 2. StickerProxyService
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `cacheCompress`
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ —Å–∂–∞—Ç–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º

### 3. application.yaml
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–ø—Ü–∏—è `app.sticker-cache.compress` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `false`)

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –≤ Redis (–±–µ–∑ —Å–∂–∞—Ç–∏—è) –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
2. **–ú–∏–≥—Ä–∞—Ü–∏—è**: –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç
3. **CPU vs Memory**: –†–µ—à–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

---

## üöÄ –ò—Ç–æ–≥

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–ë–ï–ó —Å–∂–∞—Ç–∏—è** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

–û–ø—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —ç–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏, –Ω–æ —Å —Ç–µ–∫—É—â–∏–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏ (100% hit rate) –æ–Ω–∞ –Ω–µ –Ω—É–∂–Ω–∞.

**–ê–≤—Ç–æ—Ä**: AI Assistant  
**–î–∞—Ç–∞**: 27 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è**: 1.0

