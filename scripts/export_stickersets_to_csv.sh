#!/bin/bash

# ะกะบัะธะฟั ะดะปั ัะบัะฟะพััะฐ ััะธะบะตััะตัะพะฒ ะฒ CSV ัะฐะนะป

BASE_URL="http://localhost:8080"
OUTPUT_FILE="stickersets_export.csv"

echo "๐ ะญะบัะฟะพัั ััะธะบะตััะตัะพะฒ ะฒ CSV..."

# ะะพะปััะฐะตะผ ะฒัะต ััะธะบะตััะตัั
echo "๐ ะะพะปััะฐะตะผ ัะฟะธัะพะบ ััะธะบะตััะตัะพะฒ..."
STICKERSETS_RESPONSE=$(curl -s "${BASE_URL}/api/stickersets?size=1000")

# ะัะพะฒะตััะตะผ ััะฟะตัะฝะพััั ะทะฐะฟัะพัะฐ
if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะฟะพะปััะตะฝะธะธ ะดะฐะฝะฝัั ั ัะตัะฒะตัะฐ"
    exit 1
fi

# ะกะพะทะดะฐะตะผ CSV ัะฐะนะป ั ะทะฐะณะพะปะพะฒะบะฐะผะธ
echo "id,title,name" > "$OUTPUT_FILE"

# ะะทะฒะปะตะบะฐะตะผ ะดะฐะฝะฝัะต ะธ ะทะฐะฟะธััะฒะฐะตะผ ะฒ CSV
echo "$STICKERSETS_RESPONSE" | jq -r '.content[] | [.id, .title, .name] | @csv' >> "$OUTPUT_FILE"

# ะะพะดััะธััะฒะฐะตะผ ะบะพะปะธัะตััะฒะพ ะทะฐะฟะธัะตะน
RECORD_COUNT=$(tail -n +2 "$OUTPUT_FILE" | wc -l | tr -d ' ')

echo "โ ะญะบัะฟะพัั ะทะฐะฒะตััะตะฝ!"
echo "๐ ะคะฐะนะป: $OUTPUT_FILE"
echo "๐ ะะฐะฟะธัะตะน: $RECORD_COUNT"

# ะะพะบะฐะทัะฒะฐะตะผ ะฟะตัะฒัะต ะฝะตัะบะพะปัะบะพ ัััะพะบ ะดะปั ะฟัะพะฒะตัะบะธ
echo ""
echo "๐ ะะตัะฒัะต 10 ะทะฐะฟะธัะตะน:"
head -11 "$OUTPUT_FILE"

echo ""
echo "๐ ะะพะปะฝัะน ัะฟะธัะพะบ ะดะปั ะฐะฝะฐะปะธะทะฐ:"
cat "$OUTPUT_FILE"
