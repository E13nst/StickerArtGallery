# Database Migrations with Flyway

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Flyway –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π

```
src/main/resources/db/migration/
‚îú‚îÄ‚îÄ V1_0_1__Create_stickerpack_table.sql      # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã stickerpack
‚îú‚îÄ‚îÄ V1_0_2__Create_users_table.sql            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã users  
‚îú‚îÄ‚îÄ V1_0_3__Create_stickersets_table.sql      # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã stickersets
‚îú‚îÄ‚îÄ V1_0_4__Create_chat_memory_table.sql      # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã chat_memory
‚îî‚îÄ‚îÄ V1_0_5__Update_stickerpack_table_and_add_relations.sql  # –°–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
```

## üöÄ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
- –ú–∏–≥—Ä–∞—Ü–∏–∏ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- Flyway –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `flyway_schema_history`
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –µ—Å–ª–∏ —Å—Ö–µ–º–∞ –ë–î –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è–º

### Naming Convention
–§–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏: `V{version}__{description}.sql`
- `V1_0_1` - –≤–µ—Ä—Å–∏—è (–º–∞–∂–æ—Ä–Ω–∞—è.–º–∏–Ω–æ—Ä–Ω–∞—è.–ø–∞—Ç—á)
- `__` - –¥–≤–æ–π–Ω–æ–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
- `Create_users_table` - –æ–ø–∏—Å–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

## üõ†Ô∏è –ö–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
./gradlew flywayInfo
```

### –†—É—á–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
./gradlew flywayMigrate
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
./gradlew flywayValidate
```

### –û—á–∏—Å—Ç–∫–∞ –ë–î (—Ç–æ–ª—å–∫–æ –¥–ª—è dev!)
```bash
./gradlew flywayClean
```

## üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π

### 1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
touch src/main/resources/db/migration/V1_0_6__Add_new_feature.sql
```

### 2. –ù–∞–ø–∏—Å–∞—Ç—å SQL
```sql
-- –ú–∏–≥—Ä–∞—Ü–∏—è: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
-- –í–µ—Ä—Å–∏—è: 1.0.6
-- –û–ø–∏—Å–∞–Ω–∏–µ: –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

CREATE TABLE new_table (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL
);
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
```bash
./gradlew bootRun --args='--spring.profiles.active=dev'
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

### ‚úÖ DO (–ú–æ–∂–Ω–æ)
- ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã
- ‚úÖ –î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã
- ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ –î–æ–±–∞–≤–ª—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### ‚ùå DON'T (–ù–µ–ª—å–∑—è)
- ‚ùå –ò–∑–º–µ–Ω—è—Ç—å —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚ùå –£–¥–∞–ª—è—Ç—å —Å—Ç–æ–ª–±—Ü—ã –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
- ‚ùå –ò–∑–º–µ–Ω—è—Ç—å —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞–ø—Ä—è–º—É—é
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `flywayClean` –≤ –ø—Ä–æ–¥–∞–∫—à–Ω–µ

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–æ—Ñ–∏–ª—è–º

### Development
```yaml
spring:
  flyway:
    clean-on-validation-error: true
    baseline-on-migrate: true
```

### Production
```yaml
spring:
  flyway:
    validate-on-migrate: true
    baseline-on-migrate: false
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏
Flyway —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `flyway_schema_history`:
```sql
SELECT * FROM flyway_schema_history ORDER BY installed_on DESC;
```

### –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash
# –ü–æ–∏—Å–∫ –ª–æ–≥–æ–≤ Flyway
grep -i flyway logs/app.log
```

## üö® Troubleshooting

### –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
```
FlywayException: Validate failed: Migration checksum mismatch
```
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ë–î –≤ dev —Å—Ä–µ–¥–µ

### –ù–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏
```
No migrations found
```
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É—Ç—å `classpath:db/migration` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –û—à–∏–±–∫–∞ –±–∞–∑–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
```
Unable to obtain connection from database
```
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `application.yaml`
