-- Миграция: добавление cached_image_id в generation_tasks
-- Версия: 1.0.40
-- Описание:
--   Добавление колонки cached_image_id для прямой связи между задачей генерации
--   и кешированным изображением. Это позволяет хранить UUID изображения напрямую,
--   без необходимости парсить URL.

-- ============================================================================
-- 1. Добавление колонки cached_image_id
-- ============================================================================
ALTER TABLE generation_tasks
ADD COLUMN cached_image_id UUID;

-- ============================================================================
-- 2. Добавление внешнего ключа
-- ============================================================================
ALTER TABLE generation_tasks
ADD CONSTRAINT fk_generation_tasks_cached_image
    FOREIGN KEY (cached_image_id) REFERENCES cached_images(id) ON DELETE SET NULL;

-- ============================================================================
-- 3. Создание индекса для быстрого поиска
-- ============================================================================
CREATE INDEX idx_generation_tasks_cached_image_id ON generation_tasks(cached_image_id);

-- ============================================================================
-- 4. Комментарии
-- ============================================================================
COMMENT ON COLUMN generation_tasks.cached_image_id IS 'UUID кешированного изображения (FK на cached_images.id)';
