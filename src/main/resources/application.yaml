# Конфигурация приложения
app:
  url: ${APP_URL}
  mini-app:
    url: ${MINI_APP_URL:${app.url}/mini-app/}
  telegram:
    bot-token: ${TELEGRAM_BOT_TOKEN}
    bot-username: ${TELEGRAM_BOT_USERNAME:stixlybot}
    default-sticker-set-title: ${STICKER_SET_DEFAULT_TITLE:Styxly Generated}
    webhook:
      secret: ${BACKEND_WEBHOOK_SECRET:}  # Секрет для HMAC проверки webhook от Python сервиса
  referral:
    daily-referrer-reward-cap: ${REFERRAL_DAILY_CAP:50}
    attribution-window-days: ${REFERRAL_ATTRIBUTION_WINDOW_DAYS:7}
    code-length: ${REFERRAL_CODE_LENGTH:12}
  internal:
    service-tokens:
      sticker-bot: ${STICKERBOT_SERVICE_TOKEN:}
  ai:
    context-length: ${AI_CONTEXT_LENGTH:10}  # Длина контекста для InMemoryChatMemory (количество сообщений)
    auto-category:
      max-categories: ${AI_AUTO_CATEGORY_MAX_CATEGORIES:5}
      max-retries: ${AI_AUTO_CATEGORY_MAX_RETRIES:2}
      cache-ttl-minutes: ${AI_AUTO_CATEGORY_CACHE_TTL:60}
      batch-size: ${AI_AUTO_CATEGORY_BATCH_SIZE:50}  # Для анализа всех стикерсетов
      min-stickerset-count: ${AI_AUTO_CATEGORY_MIN_COUNT:5}  # Минимум стикерсетов для новой категории
      max-new-categories: ${AI_AUTO_CATEGORY_MAX_NEW:0}  # 0 = без ограничений
  # Локальное хранилище изображений
  image-storage:
    path: ${IMAGE_STORAGE_PATH:./data/images}  # Amvera: /data/images
    retention-days: ${IMAGE_STORAGE_RETENTION_DAYS:7}  # Срок хранения в днях
    base-url: ${IMAGE_STORAGE_BASE_URL:${app.url}/api/images}  # Базовый URL для публичного доступа

spring:
  application:
    name: sticker-art-gallery
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      chat:
        options:
          model: ${OPENAI_MODEL:gpt-4o-mini}
          temperature: ${OPENAI_TEMPERATURE:0.7}
      # Разумные таймауты для запросов с изображениями
      client:
        connection-timeout: 60000   # 60 секунд (1 минута) для подключения
        read-timeout: 180000         # 180 секунд (3 минуты) для чтения (запросы с изображениями могут занимать до 2-3 минут)
#      proxy:
#        host: ${OPENAI_PROXY_HOST:}
#        port: ${OPENAI_PROXY_PORT:}
#        username: ${OPENAI_PROXY_USERNAME:}
#        password: ${OPENAI_PROXY_PASSWORD:}
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:mindbase}
    username: ${DB_USERNAME:dalek}
    password: ${DB_PASSWORD:postgres}
    driver-class-name: org.postgresql.Driver
    hikari:
      connection-timeout: 10000
      maximum-pool-size: 5
      minimum-idle: 1  # Уменьшено с 2 до 1 для экономии памяти
      leak-detection-threshold: 30000
      connection-test-query: SELECT 1
      auto-commit: false
      # Дополнительные настройки для оптимизации памяти
      idle-timeout: 300000  # 5 минут - закрывать неиспользуемые connections
      max-lifetime: 1800000  # 30 минут - максимальное время жизни connection
  jpa:
    hibernate:
      ddl-auto: validate  # Flyway управляет схемой, Hibernate только валидирует
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        use_sql_comments: false
        jdbc:
          batch_size: 20
          time_zone: UTC
        connection:
          provider_disables_autocommit: true
        # Second-level cache с Caffeine через JCache
        cache:
          use_second_level_cache: true
          use_query_cache: false  # Query cache отключён - контрпродуктивен при частых записях
          region:
            factory_class: org.hibernate.cache.jcache.internal.JCacheRegionFactory
        javax:
          cache:
            provider: com.github.benmanes.caffeine.jcache.spi.CaffeineCachingProvider
            uri: classpath:caffeine-hibernate.conf
  
  # Настройки Flyway для автоматических миграций
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    validate-on-migrate: true
    baseline-version: 1.0.0
    baseline-description: "Initial baseline"
    
  data:
    redis:
      host: ${REDIS_HOST:amvera-e13nst-run-redis}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      timeout: 2000ms        # Timeout для операций (2 сек)
      connect-timeout: 3000ms # Timeout для подключения (3 сек)
      ssl:
        enabled: ${REDIS_SSL_ENABLED:false}
      # Connection pool settings - оптимизировано для экономии памяти
      lettuce:
        pool:
          max-active: 8     # Уменьшено с 20 до 8
          max-idle: 4       # Уменьшено с 10 до 4
          min-idle: 2       # Уменьшено с 5 до 2
          max-wait: 3000ms  # Ожидание соединения
        shutdown-timeout: 100ms  # Быстрое завершение при shutdown

# Swagger/OpenAPI конфигурация
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: method
    tags-sorter: alpha
    try-it-out-enabled: true
    filter: true
  default-produces-media-type: application/json
  default-consumes-media-type: application/json

# Конфигурация прокси для внешнего сервиса стикеров
sticker:
  processor:
    url: ${STICKER_PROCESSOR_URL:https://sticker-processor-e13nst.amvera.io}
    timeout:
      connect: 5000
      read: 10000

# Конфигурация WaveSpeed API
wavespeed:
  api-key: ${WAVESPEED_API_KEY:}
  base-url: ${WAVESPEED_BASE_URL:https://api.wavespeed.ai/api/v3}
  max-poll-seconds: ${WAVESPEED_MAX_POLL_SECONDS:300}
  bg-remove-enabled: ${WAVESPEED_BG_REMOVE_ENABLED:true}
  timeout:
    connect: 5000
    read: 20000

# Подробное логирование для диагностики
logging:
  level:
    # Глобальный уровень (по умолчанию INFO, на проде можно WARN)
    root: ${LOGGING_LEVEL_ROOT:INFO}
    
    # Spring Framework компоненты
    org.springframework.jdbc: ${LOGGING_LEVEL_SPRING_JDBC:INFO}
    org.hibernate.SQL: ${LOGGING_LEVEL_HIBERNATE_SQL:INFO}
    org.hibernate.type.descriptor.sql.BasicBinder: ${LOGGING_LEVEL_HIBERNATE_BINDER:INFO}
    com.zaxxer.hikari: ${LOGGING_LEVEL_HIKARI:INFO}
    org.springframework.orm.jpa: ${LOGGING_LEVEL_SPRING_JPA:INFO}
    org.springframework.boot.autoconfigure: ${LOGGING_LEVEL_SPRING_AUTOCONFIGURE:INFO}
    org.springframework.security: ${LOGGING_LEVEL_SPRING_SECURITY:INFO}
    
    # Наше приложение (по умолчанию DEBUG локально, WARN на проде)
    com.example.sticker_art_gallery: ${LOGGING_LEVEL_APP:INFO}
  
  # Паттерн логов (опционально)
  pattern:
    console: ${LOGGING_PATTERN_CONSOLE:%d{yyyy-MM-dd HH:mm:ss} - %msg%n}
    file: ${LOGGING_PATTERN_FILE:%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n}
  
