# –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞: Telegram Stars Integration

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| **Invoice Creation** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | Java backend —Å–æ–∑–¥–∞–µ—Ç invoice —á–µ—Ä–µ–∑ Telegram Bot API |
| **PreCheckout Handler** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | Python-–±–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç pre_checkout_query |
| **Successful Payment Handler** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | Python-–±–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç successful_payment |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è initData** | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –í–∞–ª–∏–¥–∞—Ü–∏—è –µ—Å—Ç—å –≤ Java, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Python-–±–æ—Ç–µ |
| **HMAC –ø–æ–¥–ø–∏—Å—å** | ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ |
| **Retry –º–µ—Ö–∞–Ω–∏–∑–º** | ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤ |
| **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ telegramPaymentId/telegramChargeId –≤ Java |
| **Service Token Auth** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –ó–∞—â–∏—Ç–∞ internal endpoints —á–µ—Ä–µ–∑ X-Service-Token |

## Endpoints

### Java Backend (Public API)
| Endpoint | Method | Auth | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|------|----------|
| `/api/stars/packages` | GET | initData | –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ |
| `/api/stars/create-invoice` | POST | initData | –°–æ–∑–¥–∞–Ω–∏–µ invoice |
| `/api/stars/purchases` | GET | initData | –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ |

### Java Backend (Internal API)
| Endpoint | Method | Auth | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|------|----------|
| `/api/internal/stars/validate-payment` | POST | Service Token | –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞ |
| `/api/internal/stars/process-payment` | POST | Service Token | –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ |

### Python Bot (Webhook Handlers)
| Handler | Trigger | Action |
|----------|---------|--------|
| `pre_checkout_query_handler` | Telegram webhook | –í—ã–∑—ã–≤–∞–µ—Ç Java `/validate-payment` |
| `successful_payment_handler` | Telegram webhook | –í—ã–∑—ã–≤–∞–µ—Ç Java `/process-payment` |

## Payload —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### Validate Payment Request
```json
{
  "invoicePayload": "uuid-string",
  "userId": 123456789,
  "totalAmount": 50
}
```

### Process Payment Request
```json
{
  "telegramPaymentId": "payment_id",
  "telegramChargeId": "charge_id",
  "invoicePayload": "uuid-string",
  "userId": 123456789
}
```

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–æ–∫

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ó–∞–¥–∞—á–∞ | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û—Ü–µ–Ω–∫–∞ |
|-----------|--------|-----------|--------|
| üî¥ –í–´–°–û–ö–ò–ô | HMAC –ø–æ–¥–ø–∏—Å—å –¥–ª—è webhook | Python + Java | 2-3 —á–∞—Å–∞ |
| üî¥ –í–´–°–û–ö–ò–ô | Retry –º–µ—Ö–∞–Ω–∏–∑–º | Python | 2-3 —á–∞—Å–∞ |
| üü° –°–†–ï–î–ù–ò–ô | –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ | Java | 1-2 —á–∞—Å–∞ |
| üü° –°–†–ï–î–ù–ò–ô | –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | Java | 2-4 —á–∞—Å–∞ |
| üü¢ –ù–ò–ó–ö–ò–ô | Idempotency key | Java | 1-2 —á–∞—Å–∞ |
| üü¢ –ù–ò–ó–ö–ò–ô | Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | Java | 2-3 —á–∞—Å–∞ |

## –í–∞—Ä–∏–∞–Ω—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

| –í–∞—Ä–∏–∞–Ω—Ç | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|---------|-----------|------------|--------------|
| **REST API (—Ç–µ–∫—É—â–∏–π)** | –ù–∏–∑–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | ‚úÖ –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞ |
| **REST API + HMAC + Retry** | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è | ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| **Message Queue** | –í—ã—Å–æ–∫–∞—è | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | ‚úÖ –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ |

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã
- `stars_packages` - —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
- `stars_invoice_intents` - –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ (PENDING ‚Üí COMPLETED)
- `stars_purchases` - –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏
- `art_transactions` - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è ART

### –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- `stars_purchases.telegram_payment_id` (UNIQUE)
- `stars_purchases.telegram_charge_id` (UNIQUE)
- `stars_invoice_intents.invoice_payload` (UNIQUE)

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

| –ú–µ—Ö–∞–Ω–∏–∑–º | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| Service Token | ‚úÖ | SHA-256 —Ö—ç—à, –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `ServiceTokenAuthenticationFilter` |
| HMAC –ø–æ–¥–ø–∏—Å—å | ‚ùå | –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ |
| –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å | ‚úÖ | –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π |
| –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å | ‚úÖ | `@Transactional` –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è ART |

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω** - –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–∑–¥–∞–Ω—ã
2. ‚è≥ **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è HMAC** - Python + Java
3. ‚è≥ **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è Retry** - Python
4. ‚è≥ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
5. ‚è≥ **–î–µ–ø–ª–æ–π** - –ø–æ—ç—Ç–∞–ø–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- üìÑ [–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑](./TELEGRAM_STARS_INTEGRATION_ANALYSIS.md)
- üìä [–°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è](./TELEGRAM_STARS_FLOW_DIAGRAM.md)
- üìã [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Stars](./STARS_PAYMENT_INTEGRATION.md)
