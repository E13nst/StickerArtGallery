# Telegram Stars Payment Implementation Summary

**–î–∞—Ç–∞:** 2026-02-06  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ Telegram Stars –¥–ª—è –ø–æ–∫—É–ø–∫–∏ ART-–±–∞–ª–ª–æ–≤ –≤ Mini App. Backend –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é, —Å–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

---

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### ‚úÖ 1. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ (StickerBot) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –¥–≤–∞ —Å–ø–æ—Å–æ–±–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `/internal/stickersets` - —Ç–æ–ª—å–∫–æ X-Service-Token
- `/api/internal/webhooks/stars-payment` - X-Service-Token + X-Webhook-Signature (HMAC)

**–†–µ—à–µ–Ω–∏–µ:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è - –≤—Å–µ `/api/internal/**` endpoints —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–æ–ª—å–∫–æ **X-Service-Token**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —Å–ø–æ—Å–æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö internal endpoints
- –£–ø—Ä–æ—â–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- HTTPS –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–∞—â–∏—Ç—É –æ—Ç MITM
- Idempotency –ø–æ `telegram_charge_id` –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –¥—É–±–ª–µ–π

---

### ‚úÖ 2. –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è frontend

**–§–∞–π–ª:** `docs/STARS_PAYMENT_FRONTEND_GUIDE.md` (1000+ —Å—Ç—Ä–æ–∫)

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- üìä –î–∏–∞–≥—Ä–∞–º–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (Mermaid)
- üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- üì° –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö API endpoints
- üíª –ü–æ–ª–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞:
  - Vanilla JavaScript –∫–ª–∞—Å—Å `StarsPaymentService`
  - React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å hooks
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–ø–ª–∞—Ç—ã
- ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ troubleshooting
- üß™ –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- üîí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ì–æ—Ç–æ–≤—ã–π –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∫–æ–¥
- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
- –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤
- –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

### ‚úÖ 3. –î–æ–±–∞–≤–ª–µ–Ω—ã helper endpoints

#### 3.1. GET `/api/stars/config`

**–§–∞–π–ª:** `src/main/java/com/example/sticker_art_gallery/controller/StarsController.java`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è frontend

**Response:**
```json
{
  "botApiUrl": "https://stixly-e13nst.amvera.io",
  "webhookUrl": "https://your-backend.com/api/internal/webhooks/stars-payment"
}
```

**–ó–∞—á–µ–º:** Frontend –Ω–µ –Ω—É–∂–Ω–æ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å URLs - –æ–Ω–∏ –ø–æ–ª—É—á–∞—é—Ç—Å—è –∏–∑ backend

#### 3.2. GET `/api/stars/purchases/recent`

**–§–∞–π–ª:** `src/main/java/com/example/sticker_art_gallery/controller/StarsController.java`  
**–°–µ—Ä–≤–∏—Å:** `src/main/java/com/example/sticker_art_gallery/service/payment/StarsPaymentService.java`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Response:**
```json
{
  "id": 123,
  "packageCode": "BASIC",
  "packageName": "Basic Pack",
  "starsPaid": 100,
  "artCredited": 250,
  "createdAt": "2025-02-06T12:00:00Z"
}
```

**–ó–∞—á–µ–º:** –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞ –ø–æ—Å–ª–µ callback –æ—Ç Telegram

---

### ‚úÖ 4. –°–æ–∑–¥–∞–Ω DTO –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `src/main/java/com/example/sticker_art_gallery/dto/payment/StarsConfigDto.java`

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
- `botApiUrl` - URL –≤–Ω–µ—à–Ω–µ–≥–æ StickerBot API
- `webhookUrl` - URL –¥–ª—è webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `/api/stars/config`

---

### ‚úÖ 5. –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

**–§–∞–π–ª:** `scripts/test-stars-payment.sh` (300+ —Å—Ç—Ä–æ–∫)

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –¢–µ—Å—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ webhook —Å Service Token
- ‚úÖ –¢–µ—Å—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ Service Token (–æ–∂–∏–¥–∞–µ—Ç—Å—è 401)
- ‚úÖ –¢–µ—Å—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π charge_id)
- ‚úÖ –¢–µ—Å—Ç –±–µ–∑ X-Service-Token –∑–∞–≥–æ–ª–æ–≤–∫–∞
- ‚úÖ –¢–µ—Å—Ç —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º JSON
- üé® –¶–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- üìä –ü–æ–¥—Å—á–µ—Ç —É—Å–ø–µ—à–Ω—ã—Ö/–ø—Ä–æ–≤–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
./scripts/test-stars-payment.sh http://localhost:8080 your_service_token

# Production —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
./scripts/test-stars-payment.sh https://your-backend.com your_service_token
```

**–§—É–Ω–∫—Ü–∏–∏:**
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ X-Service-Token
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö edge cases
- –î–µ—Ç–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

### ‚úÖ 6. –û–±–Ω–æ–≤–ª–µ–Ω README.md

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "‚≠ê Telegram Stars Payments":**
   - –û–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
   - –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
   - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (5 —à–∞–≥–æ–≤)
   - API endpoints
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

2. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**
   - –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –≤—Å–µ—Ö internal endpoints —á–µ—Ä–µ–∑ X-Service-Token

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å":**
   - API: –¥–æ–±–∞–≤–ª–µ–Ω –ø—É–Ω–∫—Ç –æ Stars Payments
   - Mini App: –¥–æ–±–∞–≤–ª–µ–Ω –ø—É–Ω–∫—Ç –æ–± –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–ø–ª–∞—Ç—ã

4. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è":**
   - –°—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         Frontend (Mini App)                      ‚îÇ
‚îÇ  - –ü–æ–ª—É—á–∞–µ—Ç –ø–∞–∫–µ—Ç—ã: GET /api/stars/packages                    ‚îÇ
‚îÇ  - –ü–æ–ª—É—á–∞–µ—Ç config: GET /api/stars/config                      ‚îÇ
‚îÇ  - –°–æ–∑–¥–∞–µ—Ç invoice —á–µ—Ä–µ–∑ StickerBot API                        ‚îÇ
‚îÇ  - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã: Telegram.WebApp.openInvoice()       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              StickerBot API (Python - –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å)           ‚îÇ
‚îÇ  - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç initData                                          ‚îÇ
‚îÇ  - –°–æ–∑–¥–∞–µ—Ç invoice —á–µ—Ä–µ–∑ Telegram Bot API                      ‚îÇ
‚îÇ  - –ü–æ–ª—É—á–∞–µ—Ç webhook –æ—Ç Telegram –æ –ø–ª–∞—Ç–µ–∂–µ                      ‚îÇ
‚îÇ  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ Java backend + X-Service-Token        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Java Backend (—ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç)                      ‚îÇ
‚îÇ  POST /api/internal/webhooks/stars-payment                      ‚îÇ
‚îÇ  ‚îú‚îÄ WebhookSignatureValidator: –ø—Ä–æ–≤–µ—Ä–∫–∞ HMAC                   ‚îÇ
‚îÇ  ‚îú‚îÄ StarsPaymentService: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞                     ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (charge_id)                   ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞–∫–µ—Ç–∞ –∏ —Å—É–º–º—ã                               ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ ART —á–µ—Ä–µ–∑ ArtRewardService                  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ stars_purchases                           ‚îÇ
‚îÇ  ‚îî‚îÄ Response: 200 OK                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (—É–∂–µ –±—ã–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã)

### Backend

‚úÖ **–ú–æ–¥–µ–ª–∏:**
- `StarsPackageEntity` - –ø–∞–∫–µ—Ç—ã Stars
- `StarsPurchaseEntity` - –∏—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫
- `StarsProductEntity` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ (–¥–ª—è –±—É–¥—É—â–µ–≥–æ)

‚úÖ **Repositories:**
- `StarsPackageRepository`
- `StarsPurchaseRepository`

‚úÖ **Services:**
- `StarsPaymentService` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- `ArtRewardService` - –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ ART

‚úÖ **Controllers:**
- `StarsController` - –ø—É–±–ª–∏—á–Ω—ã–µ endpoints
- `StarsInternalController` - webhook endpoint

‚úÖ **Security:**
- `WebhookSignatureValidator` - –ø—Ä–æ–≤–µ—Ä–∫–∞ HMAC
- `ServiceTokenAuthenticationFilter` - –∑–∞—â–∏—Ç–∞ internal endpoints

‚úÖ **DTOs:**
- `StarsPackageDto`
- `StarsPurchaseDto`
- `TelegramWebhookRequest`
- `ProcessPaymentResponse`

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

‚úÖ **–¢–∞–±–ª–∏—Ü—ã:**
- `stars_packages` - —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–∞–∫–µ—Ç—ã (4 –ø–∞–∫–µ—Ç–∞)
- `stars_purchases` - –∏—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫
- `stars_invoice_intents` - –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏
- `stars_products` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥

‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è:** `V1_0_46__Create_stars_packages_and_purchases.sql`

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env.app)

```bash
# URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
APP_URL=https://your-backend.com

# –°–µ–∫—Ä–µ—Ç –¥–ª—è HMAC –ø—Ä–æ–≤–µ—Ä–∫–∏ webhook –æ—Ç StickerBot API
BACKEND_WEBHOOK_SECRET=db5aa85012491cdb6f0d4e8093f53a00deb048bfcb6d89541d5d6a7309aee365

# –ú–µ–∂—Å–µ—Ä–≤–∏—Å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –∑–∞—â–∏—Ç—ã /api/internal/**
STICKERBOT_SERVICE_TOKEN=your_service_token_here
```

### application.yaml

```yaml
app:
  telegram:
    webhook:
      secret: ${BACKEND_WEBHOOK_SECRET:}  # –ß–∏—Ç–∞–µ—Ç—Å—è –∏–∑ .env.app
```

---

## API Endpoints

### –ü—É–±–ª–∏—á–Ω—ã–µ (–¥–ª—è frontend)

| Endpoint | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-------|----------|
| `/api/stars/packages` | GET | –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ |
| `/api/stars/config` | GET | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (URLs) |
| `/api/stars/purchases` | GET | –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ |
| `/api/stars/purchases/recent` | GET | –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–∫—É–ø–∫–∞ |

### Internal (–¥–ª—è StickerBot API)

| Endpoint | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-------|----------|
| `/api/internal/webhooks/stars-payment` | POST | Webhook –æ –ø–ª–∞—Ç–µ–∂–µ |

**–ó–∞—â–∏—Ç–∞:** 
- `@PreAuthorize("hasRole('INTERNAL')")`
- HMAC –ø–æ–¥–ø–∏—Å—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-Webhook-Signature`

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
./gradlew bootRun --args='--spring.profiles.active=dev'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤
curl http://localhost:8080/api/stars/packages \
  -H "X-Telegram-Init-Data: user=%7B%22id%22%3A123%7D&hash=..."

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
curl http://localhost:8080/api/stars/config
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
./scripts/test-stars-payment.sh http://localhost:8080 your_secret

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã: 5/5
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–µ—Å—Ç: `src/test/java/com/example/sticker_art_gallery/controller/internal/TelegramWebhookIntegrationTest.java`

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

1. **HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å:**
   - –°–µ–∫—Ä–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `BACKEND_WEBHOOK_SECRET`
   - Canonical JSON (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)
   - Constant-time comparison –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç timing attacks

2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `telegram_charge_id` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
   - –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ webhook –Ω–µ —Å–æ–∑–¥–∞—é—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø–æ–∫—É–ø–∫–∏

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–∞–∫–µ—Ç–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–∞–∫–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω (`is_enabled = true`)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—É–º–º—ã –ø–ª–∞—Ç–µ–∂–∞

4. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**
   - Internal endpoints –∑–∞—â–∏—â–µ–Ω—ã `ServiceTokenAuthenticationFilter`
   - –ü—É–±–ª–∏—á–Ω—ã–µ endpoints —Ç—Ä–µ–±—É—é—Ç Telegram initData

### üîí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã:**
   ```java
   // ‚ùå –ù–ï –¥–µ–ª–∞–π—Ç–µ —Ç–∞–∫:
   LOGGER.debug("Secret: {}", webhookSecret);
   
   // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:
   LOGGER.debug("Secret configured: {}", webhookSecret != null && !webhookSecret.isEmpty());
   ```

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –≤ production:**
   - `APP_URL=https://your-backend.com` (–Ω–µ HTTP!)

3. **–†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç—ã:**
   - `BACKEND_WEBHOOK_SECRET` –¥–æ–ª–∂–µ–Ω –º–µ–Ω—è—Ç—å—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–¥–ª—è frontend)

1. **–ü—Ä–æ—á–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:**
   - `docs/STARS_PAYMENT_FRONTEND_GUIDE.md`

2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å UI:**
   - –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –ø–∞–∫–µ—Ç–∞–º–∏
   - –ö–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–∫–∏
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –æ—Ç Telegram

3. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å API:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `StarsPaymentService` –∫–ª–∞—Å—Å –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
   - –ò–ª–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ —Å–≤–æ–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:**
   - –õ–æ–∫–∞–ª—å–Ω–æ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ Stars
   - –í Telegram Test Environment

---

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [STARS_PAYMENT_FRONTEND_GUIDE.md](STARS_PAYMENT_FRONTEND_GUIDE.md) - –¥–ª—è frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- [STARS_PAYMENT_INTEGRATION.md](STARS_PAYMENT_INTEGRATION.md) - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è backend
- [README.md](../README.md) - –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ

### –í–Ω–µ—à–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã

- [Telegram Bot API - Payments](https://core.telegram.org/bots/api#payments)
- [Telegram Stars Documentation](https://core.telegram.org/bots/payments#telegram-stars)
- [Telegram WebApp Documentation](https://core.telegram.org/bots/webapps)
- [StickerBot API](https://stixly-e13nst.amvera.io/docs) - –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å

---

## –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### Backend ‚úÖ

- [x] Webhook endpoint —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] HMAC –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–µ–Ω–∞
- [x] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ ART —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- [x] –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞–ø–∏—Å–∞–Ω–∞

### Frontend ‚è≥ (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

- [ ] UI –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–∞–∫–µ—Ç–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å StickerBot API
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ Telegram.WebApp.openInvoice()
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Telegram

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**
   ```bash
   grep -i "payment\|webhook\|stars" logs/app.log
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã:**
   ```bash
   ./scripts/test-stars-payment.sh http://localhost:8080 your_secret
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:**
   ```bash
   echo $BACKEND_WEBHOOK_SECRET
   ```

4. **Swagger UI:**
   - http://localhost:8080/swagger-ui.html
   - –†–∞–∑–¥–µ–ª "Telegram Stars"

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Backend –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏  
**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –ü–æ–ª–Ω–∞—è –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
