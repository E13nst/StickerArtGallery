# Словарь метрик аналитики (Admin Dashboard)

## 1. Рост и активность пользователей (usersGrowth)

| Метрика | Формула / определение |
|--------|------------------------|
| **totalUsers** | COUNT(*) из `users` на момент запроса. |
| **newUsers** | Количество пользователей, у которых `created_at` попадает в выбранный диапазон `[from, to]`. Источник: `users`. |
| **activeUsers** (DAU/WAU/MAU по периоду) | Уникальные `user_id` за период по любому из событий: лайк (`likes`), дизлайк (`dislikes`), создание стикерсета (`stickersets`), свайп (`user_swipes` по `created_at` или `swipe_date`), старт генерации (`generation_audit_sessions.started_at`). Объединение через UNION по user_id за выбранный интервал. |
| **Таймсерия newUsers** | По каждому бакету (час/день/неделя): COUNT новых пользователей с `created_at` в этом бакете. |
| **Таймсерия activeUsers** | По каждому бакету: COUNT(DISTINCT user_id) по событиям лайк/дизлайк/стикерсет/свайп/генерация с датой в бакете. |

## 2. Контент-активность (contentActivity)

| Метрика | Формула / определение |
|--------|------------------------|
| **createdStickerSets** | Количество записей в `stickersets` с `created_at` в диапазоне. Учитываются только активные (state = 'ACTIVE') при необходимости; для «всего созданного» — без фильтра по state. |
| **likes** | COUNT из `likes` где `created_at` в диапазоне. |
| **dislikes** | COUNT из `dislikes` где `created_at` в диапазоне. |
| **swipes** | COUNT из `user_swipes` где `swipe_date` (или `created_at`) в диапазоне. |
| **Таймсерии** | По бакетам: количество созданных стикерсетов, лайков, дизлайков, свайпов за бакет. |

## 3. Экономика (economy)

| Метрика | Формула / определение |
|--------|------------------------|
| **artEarned** | SUM(delta) по `art_transactions` где direction = 'CREDIT' и `created_at` в диапазоне. |
| **artSpent** | ABS(SUM(delta)) по `art_transactions` где direction = 'DEBIT' и `created_at` в диапазоне. |
| **starsPurchases** | Количество или сумма покупок из `stars_purchases` (если есть amount) за период. |
| **tonTransactions** | Количество или объём из таблицы TON-транзакций за период (по структуре проекта). |
| **Таймсерии** | По бакетам: art earned, art spent (и при необходимости stars/ton). |

## 4. Генерация (generation)

| Метрика | Формула / определение |
|--------|------------------------|
| **generationRuns** | Количество сессий из `generation_audit_sessions` с `started_at` в диапазоне. |
| **generationSuccessRate** | Доля сессий с `final_status = 'COMPLETED'` (или аналог успеха) среди сессий с `started_at` в диапазоне. Формула: (успешные / всего сессий) * 100. |
| **Успешная генерация** | Сессия считается успешной, если есть финальный статус COMPLETED (или последнее событие по этапу COMPLETED — SUCCEEDED). |
| **Таймсерии** | По бакетам: количество запусков генерации; опционально — успешные vs неуспешные. |
| **breakdown generationByStageStatus** | Группировка событий из `generation_audit_events` по stage и event_status за период (для диаграмм). |

## 5. Рефералы (referrals)

| Метрика | Формула / определение |
|--------|------------------------|
| **referralConversions** | Количество реферальных событий с типом, означающим «конверсию» (например, первая награда или целевое действие), с `created_at` в диапазоне. Источник: `referral_events`. |
| **referralEventsTotal** | Общее количество событий в `referral_events` за период. |
| **referralByType** | Группировка по `event_type` из `referral_events` за период (breakdown для графика/таблицы). |

## Временные параметры

- **from, to** — границы диапазона (ISO-8601), обязательны для таймсерий и KPI за период.
- **granularity** — `hour` | `day` | `week`. Определяет размер бакета для таймсерий (date_trunc в PostgreSQL).
- **tz** — часовой пояс (например UTC) для приведения бакетов к локальному времени отчёта; хранение в БД — UTC.

## Ограничения

- Максимальный диапазон запроса: 365 дней (защита от тяжёлых запросов).
- Активность (activeUsers): учитываются только события с явной датой/временем в выбранном периоде.
